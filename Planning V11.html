<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planning Familial</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1e2a3a;
            --bg-secondary: #283848;
            --bg-card: #324558;
            --bg-calendar: #3a5068;
            --bg-cell: #4a6278;
            --bg-hover: #5a7288;
            --text-primary: #f0f4f8;
            --text-secondary: #a8c0d8;
            --text-muted: #7898b8;
            --border: #4a6278;
            
            --sabrina: #ff4d94;
            --yacine: #00c8ff;
            --melinda: #c850ff;
            --parents: #50e878;
            --autres: #ffb020;
            
            --holiday: #a080ff;
            --ferie: #ff5060;
            --accent: #50a0ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .bg-gradient {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(255,77,148,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(0,200,255,0.08) 0%, transparent 50%);
        }

        .app {
            position: relative;
            z-index: 1;
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 6px;
            overflow: hidden;
        }

        /* BARRE NAV */
        .top-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            flex-shrink: 0;
        }

        .nav-btn:active { transform: scale(0.92); background: var(--accent); }

        .nav-center { flex: 1; text-align: center; }
        .nav-month { font-size: 1.1rem; font-weight: 800; }
        .nav-year { font-size: 0.75rem; color: var(--text-muted); }

        .top-btns { display: flex; gap: 5px; flex-shrink: 0; }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
        }

        .icon-btn:active { transform: scale(0.92); background: var(--accent); color: white; }

        /* BARRE GROUPES + BOUTONS */
        .control-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .groups-scroll {
            flex: 1;
            display: flex;
            gap: 5px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .groups-scroll::-webkit-scrollbar { display: none; }

        .grp {
            flex-shrink: 0;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 700;
            white-space: nowrap;
            border: 2px solid;
            transition: all 0.2s;
        }

        .grp:active { transform: scale(0.95); }

        .grp.sabrina { background: rgba(255,77,148,0.15); color: var(--sabrina); border-color: var(--sabrina); }
        .grp.yacine { background: rgba(0,200,255,0.15); color: var(--yacine); border-color: var(--yacine); }
        .grp.melinda { background: rgba(200,80,255,0.15); color: var(--melinda); border-color: var(--melinda); }
        .grp.parents { background: rgba(80,232,120,0.15); color: var(--parents); border-color: var(--parents); }
        .grp.autres { background: rgba(255,176,32,0.15); color: var(--autres); border-color: var(--autres); }

        /* EFFET DYNAMIQUE GROUPE S√âLECTIONN√â */
        .grp.on {
            animation: pulseGroup 1.5s ease-in-out infinite;
            transform: scale(1.05);
        }

        .grp.sabrina.on { background: var(--sabrina); color: white; box-shadow: 0 0 20px var(--sabrina), 0 0 40px rgba(255,77,148,0.3); }
        .grp.yacine.on { background: var(--yacine); color: #000; box-shadow: 0 0 20px var(--yacine), 0 0 40px rgba(0,200,255,0.3); }
        .grp.melinda.on { background: var(--melinda); color: white; box-shadow: 0 0 20px var(--melinda), 0 0 40px rgba(200,80,255,0.3); }
        .grp.parents.on { background: var(--parents); color: #000; box-shadow: 0 0 20px var(--parents), 0 0 40px rgba(80,232,120,0.3); }
        .grp.autres.on { background: var(--autres); color: #000; box-shadow: 0 0 20px var(--autres), 0 0 40px rgba(255,176,32,0.3); }

        @keyframes pulseGroup {
            0%, 100% { box-shadow: 0 0 15px currentColor, 0 0 30px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 0 25px currentColor, 0 0 50px rgba(255,255,255,0.2); }
        }

        .action-btns {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .btn {
            padding: 8px 12px;
            border-radius: 10px;
            border: none;
            font-family: 'Nunito', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn:active { transform: scale(0.95); }
        .btn-danger { background: var(--ferie); color: white; }
        .btn-primary { background: var(--accent); color: white; }

        /* L√âGENDE */
        .legend {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 4px;
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .leg { display: flex; align-items: center; gap: 3px; }
        .leg-box { width: 10px; height: 10px; border-radius: 2px; }
        .leg-box.fer { background: var(--ferie); }
        .leg-box.vac { border: 2px solid var(--holiday); }
        .leg-box.we { background: var(--bg-secondary); }

        /* CALENDRIER 1 MOIS */
        .cal-wrap {
            flex: 1;
            background: var(--bg-calendar);
            border-radius: 14px;
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .days-head {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 6px;
        }

        .dh {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            padding: 4px 0;
        }

        .days {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 3px;
        }

        /* CELLULE JOUR */
        .dc {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-cell);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
            padding: 2px;
            gap: 0px;
        }

        .dc:active { transform: scale(0.92); }
        .dc.empty { background: transparent; cursor: default; }
        .dc.empty:active { transform: none; }

        /* Label en haut (F√©ri√©/Vacances) - toujours visible */
        .dc .label {
            font-size: 0.38rem;
            font-weight: 800;
            line-height: 1;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: rgba(255,255,255,0.9);
        }

        /* Num√©ro du jour */
        .dc .num { 
            font-size: 0.95rem; 
            font-weight: 700; 
            line-height: 1; 
        }

        /* Initiales r√©servation en bas */
        .dc .ini { 
            font-size: 0.42rem; 
            font-weight: 700; 
            line-height: 1;
        }

        .dc.we { background: var(--bg-secondary); }
        .dc.we .num { color: var(--text-muted); }

        /* F√©ri√© SANS r√©servation */
        .dc.fer { background: var(--ferie); }
        .dc.fer .num { color: #fff; }

        /* Vacances SANS r√©servation */
        .dc.vac { border-color: var(--holiday); background: rgba(160,128,255,0.2); }
        .dc.vac .num { color: var(--text-primary); }
        .dc.vac .label { color: var(--holiday); }

        /* S√©lection */
        .dc.sel {
            background: rgba(80,160,255,0.5) !important;
            border-color: var(--accent) !important;
            box-shadow: 0 0 8px var(--accent);
        }
        .dc.sel .num { color: #fff; }
        .dc.sel .label { color: #fff; }

        /* R√âSERVATION = COULEUR GROUPE COMPL√àTE */
        .dc.res { border-color: transparent !important; }
        .dc.res .num, .dc.res .ini, .dc.res .label { color: #fff; }
        
        .dc.res.sabrina { background: var(--sabrina) !important; }
        .dc.res.yacine { background: var(--yacine) !important; }
        .dc.res.yacine .num, .dc.res.yacine .ini, .dc.res.yacine .label { color: #000; }
        .dc.res.melinda { background: var(--melinda) !important; }
        .dc.res.parents { background: var(--parents) !important; }
        .dc.res.parents .num, .dc.res.parents .ini, .dc.res.parents .label { color: #000; }
        .dc.res.autres { background: var(--autres) !important; }
        .dc.res.autres .num, .dc.res.autres .ini, .dc.res.autres .label { color: #000; }

        /* BARRE STATUT + LIEN VISU */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
            font-size: 0.7rem;
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-muted);
        }

        .sync-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--parents);
            animation: pulse 2s infinite;
        }

        .sync-dot.off { background: var(--ferie); animation: none; }

        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

        .sel-count { color: var(--text-secondary); }
        .sel-count b { color: var(--accent); }

        .visu-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 700;
            padding: 4px 8px;
            background: rgba(80,160,255,0.15);
            border-radius: 8px;
        }

        .visu-link:active { background: rgba(80,160,255,0.3); }

        /* ============ PAGE VISU 3 MOIS ============ */
        .visu-page {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 500;
            background: var(--bg-primary);
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            overflow: hidden;
        }

        .visu-page.on { display: flex; }

        .visu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .visu-title {
            font-size: 1rem;
            font-weight: 800;
        }

        .visu-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .visu-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--ferie);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .visu-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            padding: 6px;
            font-size: 0.55rem;
        }

        .visu-leg {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 3px 6px;
            border-radius: 8px;
            font-weight: 700;
        }

        .visu-leg.sabrina { background: var(--sabrina); color: white; }
        .visu-leg.yacine { background: var(--yacine); color: #000; }
        .visu-leg.melinda { background: var(--melinda); color: white; }
        .visu-leg.parents { background: var(--parents); color: #000; }
        .visu-leg.autres { background: var(--autres); color: #000; }

        .visu-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        .visu-month {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 6px;
            display: flex;
            flex-direction: column;
        }

        .visu-month-head {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px;
            background: var(--bg-hover);
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .visu-days-head {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 2px;
        }

        .visu-dh {
            text-align: center;
            font-size: 0.4rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .visu-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .visu-dc {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-cell);
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.45rem;
            font-weight: 600;
        }

        .visu-dc.empty { background: transparent; }
        .visu-dc.we { background: var(--bg-secondary); color: var(--text-muted); }
        .visu-dc.fer { background: var(--ferie); color: white; }
        .visu-dc.vac { border: 1px solid var(--holiday); }
        .visu-dc.res.sabrina { background: var(--sabrina); color: white; }
        .visu-dc.res.yacine { background: var(--yacine); color: #000; }
        .visu-dc.res.melinda { background: var(--melinda); color: white; }
        .visu-dc.res.parents { background: var(--parents); color: #000; }
        .visu-dc.res.autres { background: var(--autres); color: #000; }

        /* MODALS */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }

        .modal-bg.on { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            width: 100%;
            max-width: 320px;
            max-height: 75vh;
            overflow-y: auto;
            animation: popIn 0.2s ease;
            border: 1px solid var(--border);
        }

        @keyframes popIn { from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1} }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-title { font-size: 0.95rem; font-weight: 700; }

        .modal-x {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--bg-hover);
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
        }

        .group-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .group-badge.sabrina { background: var(--sabrina); color: white; }
        .group-badge.yacine { background: var(--yacine); color: #000; }
        .group-badge.melinda { background: var(--melinda); color: white; }
        .group-badge.parents { background: var(--parents); color: #000; }
        .group-badge.autres { background: var(--autres); color: #000; }

        .fg { margin-bottom: 10px; }
        .fl { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; }

        .fi {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Nunito', sans-serif;
            font-size: 0.85rem;
        }

        .fi:focus { outline: none; border-color: var(--accent); }

        .dates-box {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 60px;
            overflow-y: auto;
        }

        .date-chip {
            padding: 3px 6px;
            background: var(--bg-hover);
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .modal-btns { display: flex; gap: 6px; margin-top: 12px; }
        .modal-btns .btn { flex: 1; text-align: center; padding: 10px; }

        .share-url {
            width: 100%;
            padding: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--accent);
            font-size: 0.65rem;
            font-family: 'JetBrains Mono', monospace;
            margin: 8px 0;
            text-align: center;
        }

        .help-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .help-text b { color: var(--text-primary); }

        .toasts { position: fixed; top: 50px; left: 8px; right: 8px; z-index: 2000; }

        .toast {
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            animation: slideDown 0.2s ease;
        }

        .toast.ok { border-left: 3px solid var(--parents); }
        .toast.err { border-left: 3px solid var(--ferie); }
        .toast.info { border-left: 3px solid var(--accent); }

        @keyframes slideDown { from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)} }

        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            z-index: 3000;
        }

        .loading.hide { display: none; }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to{transform:rotate(360deg)} }

        .custom-row { display: none; }
        .custom-row.show { display: block; }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <div class="loading" id="loader">
        <div class="spinner"></div>
        <span style="color:var(--text-secondary);font-size:0.8rem">Connexion...</span>
    </div>

    <!-- PAGE PRINCIPALE -->
    <div class="app">
        <div class="top-bar">
            <button class="nav-btn" onclick="navP(-1)">‚óÄ</button>
            <div class="nav-center">
                <div class="nav-month" id="navMonth">Janvier</div>
                <div class="nav-year" id="navYear">2025</div>
            </div>
            <button class="nav-btn" onclick="navP(1)">‚ñ∂</button>
            <div class="top-btns">
                <button class="icon-btn" onclick="openHelp()">‚ùì</button>
                <button class="icon-btn" onclick="openShare()">üîó</button>
            </div>
        </div>

        <div class="control-bar">
            <div class="groups-scroll" id="grps"></div>
            <div class="action-btns">
                <button class="btn btn-danger" onclick="effacer()">Effacer</button>
                <button class="btn btn-primary" onclick="reserver()">R√©server</button>
            </div>
        </div>

        <div class="legend">
            <div class="leg"><div class="leg-box fer"></div><span>F√©ri√©</span></div>
            <div class="leg"><div class="leg-box vac"></div><span>Vacances</span></div>
            <div class="leg"><div class="leg-box we"></div><span>WE</span></div>
        </div>

        <div class="cal-wrap">
            <div class="days-head">
                <span class="dh">Lun</span>
                <span class="dh">Mar</span>
                <span class="dh">Mer</span>
                <span class="dh">Jeu</span>
                <span class="dh">Ven</span>
                <span class="dh">Sam</span>
                <span class="dh">Dim</span>
            </div>
            <div class="days" id="daysGrid"></div>
        </div>

        <div class="status-bar">
            <div class="sync-info">
                <div class="sync-dot" id="syncDot"></div>
                <span id="syncTxt">Cloud</span>
            </div>
            <div class="sel-count"><b id="selN">0</b> s√©lect.</div>
            <a href="#" class="visu-link" onclick="openVisu();return false;">üìÖ Visu 3 mois</a>
        </div>
    </div>

    <!-- PAGE VISU 3 MOIS -->
    <div class="visu-page" id="visuPage">
        <div class="visu-header">
            <div class="visu-nav">
                <button class="nav-btn" onclick="visuNav(-3)">‚óÄ</button>
            </div>
            <div class="visu-title" id="visuTitle">Jan - Mar 2025</div>
            <div class="visu-nav">
                <button class="nav-btn" onclick="visuNav(3)">‚ñ∂</button>
                <button class="visu-close" onclick="closeVisu()">‚úï</button>
            </div>
        </div>

        <div class="visu-legend">
            <div class="visu-leg sabrina">Sabrina</div>
            <div class="visu-leg yacine">Yacine</div>
            <div class="visu-leg melinda">Melinda</div>
            <div class="visu-leg parents">Parents</div>
            <div class="visu-leg autres">Autres</div>
        </div>

        <div class="visu-grid" id="visuGrid"></div>
    </div>

    <!-- MODALS -->
    <div class="modal-bg" id="mRes" onclick="if(event.target===this)closeM('mRes')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">Nouvelle r√©servation</h2>
                <button class="modal-x" onclick="closeM('mRes')">√ó</button>
            </div>
            <div class="group-badge" id="groupBadge">Sabrina</div>
            <div class="fg custom-row" id="customRow">
                <label class="fl">Nom</label>
                <input type="text" class="fi" id="customName" placeholder="Pr√©nom...">
            </div>
            <div class="fg">
                <label class="fl">Dates</label>
                <div class="dates-box" id="datesBox"></div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="confirmerRes()" style="width:100%">Confirmer</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="mShare" onclick="if(event.target===this)closeM('mShare')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">üîó Partager</h2>
                <button class="modal-x" onclick="closeM('mShare')">√ó</button>
            </div>
            <p class="help-text"><b>Envoyez ce lien √† la famille !</b></p>
            <input type="text" class="share-url" id="shareUrl" readonly onclick="this.select()">
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="copyUrl()" style="width:100%">üìã Copier</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="mHelp" onclick="if(event.target===this)closeM('mHelp')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">‚ùì Aide</h2>
                <button class="modal-x" onclick="closeM('mHelp')">√ó</button>
            </div>
            <p class="help-text" style="background:var(--bg-secondary);padding:10px;border-radius:6px">
                <b style="color:var(--parents)">‚úì 100% automatique !</b><br>
                Rien √† configurer. Partage le lien üîó
            </p>
            <p class="help-text"><b>R√©server :</b> Groupe ‚Üí Jours ‚Üí R√©server</p>
            <p class="help-text"><b>Supprimer :</b> Jours ‚Üí Effacer</p>
            <p class="help-text"><b>Visu 3 mois :</b> Vue d'ensemble</p>
        </div>
    </div>

    <div class="toasts" id="toasts"></div>

    <script>
        const API = 'https://jsonblob.com/api/jsonBlob';
        const MOIS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
        const MOIS_COURT = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
        const GRP = [
            {id:'sabrina', nom:'Sabrina', ini:'SAB'},
            {id:'yacine', nom:'Yacine', ini:'YAC'},
            {id:'melinda', nom:'Melinda', ini:'MEL'},
            {id:'parents', nom:'Parents', ini:'PAR'},
            {id:'autres', nom:'Autres', ini:'AUT'}
        ];

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let visuMonth = new Date().getMonth();
        let visuYear = new Date().getFullYear();
        let G = 'sabrina';
        let sel = new Set();
        let data = { reservations: [], emails: [] };
        let blobId = null;

        // CLOUD
        async function initCloud() {
            const params = new URLSearchParams(location.search);
            blobId = params.get('id');
            if (blobId) { if (await chargerCloud()) { updateUrl(); return; } }
            try {
                const r = await fetch(API, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                if (r.ok) { blobId = r.headers.get('Location').split('/').pop(); updateUrl(); setSync(true); }
            } catch(e) { setSync(false); }
        }

        async function sauvegarder() {
            if (!blobId) return false;
            try {
                const r = await fetch(`${API}/${blobId}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                setSync(r.ok); return r.ok;
            } catch(e) { setSync(false); return false; }
        }

        async function chargerCloud() {
            if (!blobId) return false;
            try {
                const r = await fetch(`${API}/${blobId}`);
                if (r.ok) { data = await r.json(); renderCal(); renderVisu(); setSync(true); return true; }
            } catch(e) {}
            setSync(false); return false;
        }

        function updateUrl() {
            if (blobId) {
                const url = `${location.origin}${location.pathname}?id=${blobId}`;
                history.replaceState({}, '', url);
                document.getElementById('shareUrl').value = url;
            }
        }

        function setSync(ok) {
            document.getElementById('syncDot').className = 'sync-dot' + (ok ? '' : ' off');
            document.getElementById('syncTxt').textContent = ok ? 'En ligne ‚úì' : 'Offline';
        }

        // F√âRI√âS
        function feries(y) {
            const f = [
                {d:`${y}-01-01`,n:"F√âRI√â"}, {d:`${y}-05-01`,n:"F√âRI√â"},
                {d:`${y}-05-08`,n:"F√âRI√â"}, {d:`${y}-07-14`,n:"F√âRI√â"},
                {d:`${y}-08-15`,n:"F√âRI√â"}, {d:`${y}-11-01`,n:"F√âRI√â"},
                {d:`${y}-11-11`,n:"F√âRI√â"}, {d:`${y}-12-25`,n:"F√âRI√â"}
            ];
            const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4;
            const z=Math.floor((b+8)/25),g=Math.floor((b-z+1)/3);
            const h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4;
            const l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
            const mo=Math.floor((h+l-7*m+114)/31),da=((h+l-7*m+114)%31)+1;
            const p=new Date(y,mo-1,da);
            const add=(dt,n)=>{const r=new Date(dt);r.setDate(dt.getDate()+n);return r};
            f.push({d:fmt(add(p,1)),n:"F√âRI√â"},{d:fmt(add(p,39)),n:"F√âRI√â"},{d:fmt(add(p,50)),n:"F√âRI√â"});
            return f;
        }

        // VACANCES
        function vacances(y) {
            const v=[];
            const add=(s,e)=>{const sd=new Date(s),ed=new Date(e);for(let d=new Date(sd);d<=ed;d.setDate(d.getDate()+1))if(d.getFullYear()===y)v.push({d:fmt(d),n:"VAC"})};
            if(y===2025){add('2025-02-22','2025-03-10');add('2025-04-19','2025-05-05');add('2025-07-05','2025-09-01');add('2025-10-18','2025-11-03');add('2025-12-20','2025-12-31')}
            if(y===2026){add('2026-01-01','2026-01-05');add('2026-02-14','2026-03-02');add('2026-04-11','2026-04-27');add('2026-07-04','2026-09-01');add('2026-10-17','2026-11-02');add('2026-12-19','2026-12-31')}
            return v;
        }

        function fmt(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

        // RENDER GROUPES
        function renderG() {
            document.getElementById('grps').innerHTML = GRP.map(g => 
                `<div class="grp ${g.id} ${G===g.id?'on':''}" onclick="selG('${g.id}')">${g.nom}</div>`
            ).join('');
        }

        // RENDER CALENDRIER 1 MOIS
        function renderCal() {
            const grid = document.getElementById('daysGrid');
            const fer = feries(currentYear);
            const vac = vacances(currentYear);
            const ferSet = new Set(fer.map(f => f.d));
            const vacSet = new Set(vac.map(v => v.d));
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = (new Date(currentYear, currentMonth, 1).getDay() + 6) % 7;
            
            let h = '';
            
            for (let i = 0; i < firstDay; i++) h += '<div class="dc empty"></div>';
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(currentYear, currentMonth, d);
                const ds = fmt(dt);
                const dow = (dt.getDay() + 6) % 7;
                const isWE = dow >= 5;
                
                const isFer = ferSet.has(ds);
                const isVac = vacSet.has(ds);
                const res = data.reservations.find(r => r.dates.includes(ds));
                const isSel = sel.has(ds);
                
                let cls = ['dc'];
                let label = '';
                let ini = '';
                
                // D√©termine le label (f√©ri√© ou vacances)
                if (isFer) {
                    label = '<span class="label">F√âRI√â</span>';
                } else if (isVac) {
                    label = '<span class="label">VAC</span>';
                }
                
                // Si r√©servation : COULEUR DU GROUPE (prioritaire)
                if (res) {
                    cls.push('res', res.groupId);
                    const g = GRP.find(x => x.id === res.groupId);
                    ini = res.customName ? res.customName.substring(0,3).toUpperCase() : g.ini;
                } else {
                    // Pas de r√©servation : afficher f√©ri√©/vacances/we normalement
                    if (isFer) {
                        cls.push('fer');
                    } else if (isVac) {
                        cls.push('vac');
                    } else if (isWE) {
                        cls.push('we');
                    }
                }
                
                if (isSel) cls.push('sel');
                
                h += `<div class="${cls.join(' ')}" onclick="toggleDate('${ds}')">
                    ${label}
                    <span class="num">${d}</span>
                    ${ini ? `<span class="ini">${ini}</span>` : ''}
                </div>`;
            }
            
            const totalCells = firstDay + daysInMonth;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remaining; i++) h += '<div class="dc empty"></div>';
            
            grid.innerHTML = h;
            document.getElementById('navMonth').textContent = MOIS[currentMonth];
            document.getElementById('navYear').textContent = currentYear;
        }

        // RENDER VISU 3 MOIS
        function renderVisu() {
            const grid = document.getElementById('visuGrid');
            let h = '';
            
            for (let m = 0; m < 3; m++) {
                const month = (visuMonth + m) % 12;
                const year = visuYear + Math.floor((visuMonth + m) / 12);
                
                const fer = feries(year);
                const vac = vacances(year);
                const ferSet = new Set(fer.map(f => f.d));
                const vacSet = new Set(vac.map(v => v.d));
                
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
                
                h += `<div class="visu-month">
                    <div class="visu-month-head">${MOIS[month]} ${year}</div>
                    <div class="visu-days-head">
                        <span class="visu-dh">L</span><span class="visu-dh">M</span><span class="visu-dh">M</span>
                        <span class="visu-dh">J</span><span class="visu-dh">V</span><span class="visu-dh">S</span><span class="visu-dh">D</span>
                    </div>
                    <div class="visu-days">`;
                
                for (let i = 0; i < firstDay; i++) h += '<div class="visu-dc empty"></div>';
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const dt = new Date(year, month, d);
                    const ds = fmt(dt);
                    const dow = (dt.getDay() + 6) % 7;
                    
                    const isFer = ferSet.has(ds);
                    const isVac = vacSet.has(ds);
                    const res = data.reservations.find(r => r.dates.includes(ds));
                    
                    let cls = ['visu-dc'];
                    
                    // R√©servation prioritaire sur tout
                    if (res) {
                        cls.push('res', res.groupId);
                    } else if (isFer) {
                        cls.push('fer');
                    } else if (isVac) {
                        cls.push('vac');
                    } else if (dow >= 5) {
                        cls.push('we');
                    }
                    
                    h += `<div class="${cls.join(' ')}">${d}</div>`;
                }
                
                h += '</div></div>';
            }
            
            grid.innerHTML = h;
            
            const endMonth = (visuMonth + 2) % 12;
            const endYear = visuYear + Math.floor((visuMonth + 2) / 12);
            document.getElementById('visuTitle').textContent = `${MOIS_COURT[visuMonth]} - ${MOIS_COURT[endMonth]} ${endYear}`;
        }

        function updN() { document.getElementById('selN').textContent = sel.size; }

        // ACTIONS
        function selG(id) { G = id; renderG(); }
        function toggleDate(ds) { sel.has(ds) ? sel.delete(ds) : sel.add(ds); renderCal(); updN(); }
        function navP(dir) {
            currentMonth += dir;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCal();
        }

        // VISU
        function openVisu() { 
            visuMonth = currentMonth; 
            visuYear = currentYear; 
            renderVisu(); 
            document.getElementById('visuPage').classList.add('on'); 
        }
        function closeVisu() { document.getElementById('visuPage').classList.remove('on'); }
        function visuNav(dir) {
            visuMonth += dir;
            while (visuMonth > 11) { visuMonth -= 12; visuYear++; }
            while (visuMonth < 0) { visuMonth += 12; visuYear--; }
            renderVisu();
        }

        // EFFACER
        async function effacer() {
            if (sel.size === 0) { toast('S√©lectionnez des dates', 'info'); return; }
            let supprime = false;
            data.reservations.forEach(r => {
                const avant = r.dates.length;
                r.dates = r.dates.filter(d => !sel.has(d));
                if (r.dates.length < avant) supprime = true;
            });
            data.reservations = data.reservations.filter(r => r.dates.length > 0);
            if (supprime) {
                const ok = await sauvegarder();
                toast(ok ? 'Supprim√© ‚úì' : 'Erreur', ok ? 'ok' : 'err');
            } else {
                toast('Aucune r√©servation', 'info');
            }
            sel.clear(); renderCal(); renderVisu(); updN();
        }

        // R√âSERVER
        function reserver() {
            if (sel.size === 0) { toast('S√©lectionnez des dates', 'info'); return; }
            const g = GRP.find(x => x.id === G);
            document.getElementById('groupBadge').className = 'group-badge ' + G;
            document.getElementById('groupBadge').textContent = g.nom;
            document.getElementById('customRow').className = 'fg custom-row' + (G === 'autres' ? ' show' : '');
            document.getElementById('datesBox').innerHTML = Array.from(sel).sort().map(ds => {
                const dt = new Date(ds);
                return `<span class="date-chip">${dt.getDate()}/${dt.getMonth()+1}</span>`;
            }).join('');
            document.getElementById('mRes').classList.add('on');
        }

        async function confirmerRes() {
            let cust = '';
            if (G === 'autres') {
                cust = document.getElementById('customName').value.trim();
                if (!cust) { toast('Entrez un nom', 'err'); return; }
            }
            data.reservations.forEach(r => { r.dates = r.dates.filter(d => !sel.has(d)); });
            data.reservations = data.reservations.filter(r => r.dates.length > 0);
            data.reservations.push({ id: Date.now(), groupId: G, customName: cust, dates: Array.from(sel), createdAt: new Date().toISOString() });
            const ok = await sauvegarder();
            toast(ok ? 'R√©serv√© ‚úì' : 'Erreur', ok ? 'ok' : 'err');
            closeM('mRes');
            document.getElementById('customName').value = '';
            sel.clear(); renderCal(); renderVisu(); updN();
        }

        function openShare() { document.getElementById('shareUrl').value = location.href; document.getElementById('mShare').classList.add('on'); }
        function copyUrl() { navigator.clipboard.writeText(location.href); toast('Lien copi√© ! üìã', 'ok'); }
        function openHelp() { document.getElementById('mHelp').classList.add('on'); }
        function closeM(id) { document.getElementById(id).classList.remove('on'); }
        
        function toast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 2500);
        }

        // INIT
        async function init() {
            await initCloud();
            renderG();
            renderCal();
            renderVisu();
            updN();
            document.getElementById('loader').classList.add('hide');
            setInterval(chargerCloud, 10000);
        }
        
        init();
    </script>
</body>
</html>
