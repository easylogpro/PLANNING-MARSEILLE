<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planning Familial</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a2332;
            --bg-card: #253044;
            --bg-calendar: #1e2d40;
            --bg-cell: #3d5a80;
            --text-dark: #1a2332;
            --text-light: #ffffff;
            --text-muted: #8899aa;
            
            --sabrina: #ff1a6c;
            --yacine: #00b8e6;
            --melinda: #ff8c00;
            --parents: #00d45a;
            --autres: #a0826d;
            
            --ferie: #ffe066;
            --vac: #7a9bb8;
            --we: #6a7a8a;
            --accent: #2980d9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { height: 100%; overflow: hidden; touch-action: pan-y; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-light);
        }

        .app {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 6px;
            gap: 6px;
            overflow: hidden;
        }

        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 14px;
        }

        .month-display {
            flex: 1;
            text-align: center;
        }
        .month-name {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: 3px;
        }
        .month-year {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 700;
        }

        .header-btns { display: flex; gap: 6px; }
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
        }
        .icon-btn:active { background: var(--accent); transform: scale(0.95); }

        /* GROUPES - RESPONSIVE */
        .groups {
            display: flex;
            gap: 4px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 14px;
        }

        .grp {
            flex: 1;
            min-width: 0;
            padding: 10px 4px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 800;
            text-align: center;
            border: 2px solid;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .grp:active { transform: scale(0.95); }

        .grp.sabrina { background: rgba(255,26,108,0.15); color: var(--sabrina); border-color: var(--sabrina); }
        .grp.yacine { background: rgba(0,184,230,0.15); color: var(--yacine); border-color: var(--yacine); }
        .grp.melinda { background: rgba(255,140,0,0.15); color: var(--melinda); border-color: var(--melinda); }
        .grp.parents { background: rgba(0,212,90,0.15); color: var(--parents); border-color: var(--parents); }
        .grp.autres { background: rgba(160,130,109,0.15); color: var(--autres); border-color: var(--autres); }

        .grp.on {
            animation: pulseGlow 1.2s ease-in-out infinite;
            transform: scale(1.02);
        }

        .grp.sabrina.on { background: var(--sabrina); color: white; box-shadow: 0 0 20px var(--sabrina); }
        .grp.yacine.on { background: var(--yacine); color: white; box-shadow: 0 0 20px var(--yacine); }
        .grp.melinda.on { background: var(--melinda); color: white; box-shadow: 0 0 20px var(--melinda); }
        .grp.parents.on { background: var(--parents); color: white; box-shadow: 0 0 20px var(--parents); }
        .grp.autres.on { background: var(--autres); color: white; box-shadow: 0 0 20px var(--autres); }

        @keyframes pulseGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* CALENDRIER */
        .cal-wrap {
            flex: 1;
            background: var(--bg-calendar);
            border-radius: 16px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 14px;
            padding: 6px;
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--text-light);
        }

        .leg { display: flex; align-items: center; gap: 5px; }
        .leg-box { width: 14px; height: 14px; border-radius: 4px; }
        .leg-box.fer { background: var(--ferie); }
        .leg-box.vac { 
            background: repeating-linear-gradient(
                45deg,
                #3d5a80,
                #3d5a80 2px,
                #7a9bb8 2px,
                #7a9bb8 4px
            );
        }
        .leg-box.we { background: var(--we); }

        .days-head {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 4px;
        }

        .dh {
            text-align: center;
            font-size: 0.8rem;
            font-weight: 900;
            color: var(--text-light);
            padding: 4px 0;
        }

        .swipe-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            touch-action: pan-x;
        }

        .days {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 4px;
        }

        /* CELLULES - PLUS GRANDES */
        .dc {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-cell);
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            border: 3px solid transparent;
            gap: 1px;
        }

        .dc:active { transform: scale(0.92); }
        .dc.empty { background: transparent; cursor: default; }
        .dc.empty:active { transform: none; }

        .dc .label {
            font-size: 0.5rem;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            line-height: 1;
        }

        .dc .num { 
            font-size: 1.3rem; 
            font-weight: 900; 
            line-height: 1;
            color: white;
        }

        .dc .ini { 
            font-size: 0.6rem; 
            font-weight: 900; 
            line-height: 1;
            color: white;
        }

        .dc.we { background: var(--we); }
        .dc.fer { background: var(--ferie); }
        .dc.fer .num, .dc.fer .label { color: #000; }
        .dc.vac { 
            background: repeating-linear-gradient(
                45deg,
                var(--bg-cell),
                var(--bg-cell) 4px,
                var(--vac) 4px,
                var(--vac) 8px
            );
        }

        .dc.sel {
            border-color: var(--accent) !important;
            box-shadow: 0 0 12px var(--accent);
        }

        .dc.res.sabrina { background: var(--sabrina) !important; }
        .dc.res.yacine { background: var(--yacine) !important; }
        .dc.res.melinda { background: var(--melinda) !important; }
        .dc.res.parents { background: var(--parents) !important; }
        .dc.res.autres { background: var(--autres) !important; }

        .swipe-hint {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 3px;
        }

        /* BARRE DU BAS */
        .bottom-bar {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 14px;
        }

        .bottom-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 1.4rem;
            font-weight: 900;
            cursor: pointer;
            flex-shrink: 0;
        }
        .nav-btn:active { transform: scale(0.92); opacity: 0.8; }

        .status {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--parents);
            animation: pulse 2s infinite;
        }
        .sync-dot.off { background: #ff3b4a; animation: none; }

        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

        .sync-txt {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .sel-count {
            font-size: 0.9rem;
            font-weight: 800;
        }
        .sel-count b { color: var(--accent); font-size: 1.1rem; }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 14px 16px;
            border-radius: 12px;
            border: none;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.95); }
        .btn-danger { background: #ff3b4a; color: white; }
        .btn-primary { background: var(--accent); color: white; }

        /* MODALS */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-bg.on { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 20px;
            width: 100%;
            max-width: 340px;
            animation: popIn 0.2s ease;
        }

        @keyframes popIn { from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1} }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .modal-title { font-size: 1.1rem; font-weight: 900; }
        .modal-x {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .group-badge {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: 900;
            margin-bottom: 14px;
            color: white;
        }
        .group-badge.sabrina { background: var(--sabrina); }
        .group-badge.yacine { background: var(--yacine); }
        .group-badge.melinda { background: var(--melinda); }
        .group-badge.parents { background: var(--parents); }
        .group-badge.autres { background: var(--autres); }

        .fg { margin-bottom: 12px; }
        .fl { display: block; font-size: 0.85rem; font-weight: 800; margin-bottom: 6px; color: var(--text-muted); }
        .fi {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
        }
        .fi:focus { outline: none; border-color: var(--accent); }

        .dates-box {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 90px;
            overflow-y: auto;
        }

        .date-chip {
            padding: 5px 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 800;
        }

        .modal-btns { display: flex; gap: 10px; margin-top: 16px; }
        .modal-btns .btn { flex: 1; }

        .share-url {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: none;
            border-radius: 10px;
            color: var(--accent);
            font-size: 0.7rem;
            font-family: monospace;
            margin: 12px 0;
            text-align: center;
        }

        .help-text {
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .help-text b { color: white; }

        .toasts { position: fixed; top: 60px; left: 10px; right: 10px; z-index: 2000; }
        .toast {
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 800;
            animation: slideDown 0.2s ease;
        }
        .toast.ok { border-left: 4px solid var(--parents); }
        .toast.err { border-left: 4px solid #ff3b4a; }
        .toast.info { border-left: 4px solid var(--accent); }

        @keyframes slideDown { from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)} }

        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 3000;
        }
        .loading.hide { display: none; }

        .spinner {
            width: 46px;
            height: 46px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to{transform:rotate(360deg)} }

        .custom-row { display: none; }
        .custom-row.show { display: block; }
    </style>
</head>
<body>
    <div class="loading" id="loader">
        <div class="spinner"></div>
        <span style="color:var(--text-muted);font-size:0.9rem">Connexion...</span>
    </div>

    <div class="app">
        <div class="header">
            <div class="month-display">
                <div class="month-name" id="navMonth">Janvier</div>
                <div class="month-year" id="navYear">2026</div>
            </div>
            <div class="header-btns">
                <button class="icon-btn" onclick="openHelp()">‚ùì</button>
                <button class="icon-btn" onclick="openShare()">üîó</button>
            </div>
        </div>

        <div class="groups" id="grps"></div>

        <div class="cal-wrap">
            <div class="legend">
                <div class="leg"><div class="leg-box fer"></div><span>F√©ri√©</span></div>
                <div class="leg"><div class="leg-box vac"></div><span>Vacances</span></div>
                <div class="leg"><div class="leg-box we"></div><span>WE</span></div>
            </div>
            <div class="days-head">
                <span class="dh">Lun</span>
                <span class="dh">Mar</span>
                <span class="dh">Mer</span>
                <span class="dh">Jeu</span>
                <span class="dh">Ven</span>
                <span class="dh">Sam</span>
                <span class="dh">Dim</span>
            </div>
            <div class="swipe-container" id="swipeContainer">
                <div class="days" id="daysGrid"></div>
            </div>
            <div class="swipe-hint">‚Üê Balayer pour changer de mois ‚Üí</div>
        </div>

        <div class="bottom-bar">
            <div class="bottom-row">
                <button class="nav-btn" onclick="navP(-1)">‚óÄ</button>
                <div class="status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span class="sync-txt" id="syncTxt">Connexion...</span>
                </div>
                <div class="sel-count"><b id="selN">0</b> s√©lect.</div>
                <button class="nav-btn" onclick="navP(1)">‚ñ∂</button>
            </div>
            <div class="action-btns">
                <button class="btn btn-danger" onclick="effacer()">Effacer</button>
                <button class="btn btn-primary" onclick="reserver()">R√©server</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-bg" id="mRes" onclick="if(event.target===this)closeM('mRes')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">R√©servation</h2>
                <button class="modal-x" onclick="closeM('mRes')">√ó</button>
            </div>
            <div class="group-badge" id="groupBadge">Sabrina</div>
            <div class="fg custom-row" id="customRow">
                <label class="fl">Nom</label>
                <input type="text" class="fi" id="customName" placeholder="Pr√©nom...">
            </div>
            <div class="fg">
                <label class="fl">Dates s√©lectionn√©es</label>
                <div class="dates-box" id="datesBox"></div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="confirmerRes()">Confirmer</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="mShare" onclick="if(event.target===this)closeM('mShare')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">üîó Partager</h2>
                <button class="modal-x" onclick="closeM('mShare')">√ó</button>
            </div>
            <p class="help-text"><b>Envoie ce lien √† la famille !</b><br>Tous verront le m√™me planning.</p>
            <input type="text" class="share-url" id="shareUrl" readonly onclick="this.select()">
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="copyUrl()">üìã Copier le lien</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="mHelp" onclick="if(event.target===this)closeM('mHelp')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">‚ùì Aide</h2>
                <button class="modal-x" onclick="closeM('mHelp')">√ó</button>
            </div>
            <p class="help-text" style="background:rgba(0,212,90,0.2);padding:12px;border-radius:10px;margin-bottom:14px">
                <b style="color:var(--parents)">‚úì Sauvegarde 100% en ligne</b><br>
                Gratuit, pas de compte !
            </p>
            <p class="help-text"><b>R√©server :</b> Groupe ‚Üí Jours ‚Üí R√©server</p>
            <p class="help-text"><b>Supprimer :</b> Jours ‚Üí Effacer</p>
        </div>
    </div>

    <div class="toasts" id="toasts"></div>

    <script>
        // ============ FIREBASE REALTIME DATABASE (GRATUIT, FIABLE) ============
        const FIREBASE_URL = 'https://planning-marseille-default-rtdb.europe-west1.firebasedatabase.app';
        
        const MOIS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
        const GRP = [
            {id:'sabrina', nom:'Sabrina', ini:'SAB'},
            {id:'yacine', nom:'Yacine', ini:'YAC'},
            {id:'melinda', nom:'Melinda', ini:'MEL'},
            {id:'parents', nom:'Parents', ini:'PAR'},
            {id:'autres', nom:'Autres', ini:'AUT'}
        ];

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let G = 'sabrina';
        let sel = new Set();
        let data = { reservations: [] };
        let planningId = null;
        let isOnline = false;

        // ============ FIREBASE ============
        async function initCloud() {
            const params = new URLSearchParams(location.search);
            planningId = params.get('id');
            
            if (planningId) {
                const ok = await chargerCloud();
                if (ok) {
                    updateUrl();
                    return;
                }
            }
            await creerCloud();
        }

        async function creerCloud() {
            setSync(false, 'Cr√©ation...');
            try {
                // G√©n√©rer un ID unique
                planningId = 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const response = await fetch(`${FIREBASE_URL}/plannings/${planningId}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Erreur ' + response.status);
                
                updateUrl();
                setSync(true);
                toast('Planning cr√©√© !', 'ok');
            } catch(e) {
                console.error('Cr√©ation:', e);
                setSync(false, 'Erreur');
                toast('Erreur cr√©ation', 'err');
            }
        }

        async function sauvegarder() {
            if (!planningId) return false;
            setSync(false, 'Sauvegarde...');
            try {
                const response = await fetch(`${FIREBASE_URL}/plannings/${planningId}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Erreur ' + response.status);
                
                setSync(true);
                return true;
            } catch(e) {
                console.error('Sauvegarde:', e);
                setSync(false, 'Erreur');
                toast('Erreur sauvegarde', 'err');
                return false;
            }
        }

        async function chargerCloud() {
            if (!planningId) return false;
            setSync(false, 'Chargement...');
            try {
                const response = await fetch(`${FIREBASE_URL}/plannings/${planningId}.json`);
                
                if (!response.ok) throw new Error('Erreur ' + response.status);
                
                const result = await response.json();
                
                if (result) {
                    data = result;
                    if (!data.reservations) data.reservations = [];
                    renderCal();
                    setSync(true);
                    return true;
                } else {
                    // Planning n'existe pas
                    return false;
                }
            } catch(e) {
                console.error('Chargement:', e);
                setSync(false, 'Erreur');
                return false;
            }
        }

        function updateUrl() {
            if (planningId) {
                const url = `${location.origin}${location.pathname}?id=${planningId}`;
                history.replaceState({}, '', url);
                document.getElementById('shareUrl').value = url;
            }
        }

        function setSync(ok, txt) {
            isOnline = ok;
            document.getElementById('syncDot').className = 'sync-dot' + (ok ? '' : ' off');
            document.getElementById('syncTxt').textContent = txt || (ok ? 'En ligne ‚úì' : 'Hors ligne');
        }

        // ============ F√âRI√âS ============
        function feries(y) {
            const f = [`${y}-01-01`, `${y}-05-01`, `${y}-05-08`, `${y}-07-14`, `${y}-08-15`, `${y}-11-01`, `${y}-11-11`, `${y}-12-25`];
            const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4;
            const z=Math.floor((b+8)/25),g=Math.floor((b-z+1)/3);
            const h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4;
            const l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
            const mo=Math.floor((h+l-7*m+114)/31),da=((h+l-7*m+114)%31)+1;
            const p=new Date(y,mo-1,da);
            const add=(dt,n)=>{const r=new Date(dt);r.setDate(dt.getDate()+n);return fmt(r)};
            f.push(add(p,1), add(p,39), add(p,50));
            return new Set(f);
        }

        function vacances(y) {
            const v=[];
            const add=(s,e)=>{const sd=new Date(s),ed=new Date(e);for(let d=new Date(sd);d<=ed;d.setDate(d.getDate()+1))if(d.getFullYear()===y)v.push(fmt(d))};
            if(y===2025){add('2025-02-22','2025-03-10');add('2025-04-19','2025-05-05');add('2025-07-05','2025-09-01');add('2025-10-18','2025-11-03');add('2025-12-20','2025-12-31')}
            if(y===2026){add('2026-01-01','2026-01-05');add('2026-02-14','2026-03-02');add('2026-04-11','2026-04-27');add('2026-07-04','2026-09-01');add('2026-10-17','2026-11-02');add('2026-12-19','2026-12-31')}
            return new Set(v);
        }

        function fmt(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

        // ============ RENDER ============
        function renderG() {
            document.getElementById('grps').innerHTML = GRP.map(g => 
                `<div class="grp ${g.id} ${G===g.id?'on':''}" onclick="selG('${g.id}')">${g.nom}</div>`
            ).join('');
        }

        function renderCal() {
            const grid = document.getElementById('daysGrid');
            const ferSet = feries(currentYear);
            const vacSet = vacances(currentYear);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = (new Date(currentYear, currentMonth, 1).getDay() + 6) % 7;
            
            let h = '';
            for (let i = 0; i < firstDay; i++) h += '<div class="dc empty"></div>';
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(currentYear, currentMonth, d);
                const ds = fmt(dt);
                const dow = (dt.getDay() + 6) % 7;
                const isWE = dow >= 5;
                const isFer = ferSet.has(ds);
                const isVac = vacSet.has(ds);
                const res = data.reservations.find(r => r.dates && r.dates.includes(ds));
                const isSel = sel.has(ds);
                
                let cls = ['dc'];
                let label = '';
                let ini = '';
                
                if (isFer) label = '<span class="label">F√âRI√â</span>';
                else if (isVac) label = '<span class="label">VAC</span>';
                
                if (res) {
                    cls.push('res', res.groupId);
                    const g = GRP.find(x => x.id === res.groupId);
                    ini = res.customName ? res.customName.substring(0,3).toUpperCase() : g.ini;
                } else if (isFer) {
                    cls.push('fer');
                } else if (isVac) {
                    cls.push('vac');
                } else if (isWE) {
                    cls.push('we');
                }
                
                if (isSel) cls.push('sel');
                
                h += `<div class="${cls.join(' ')}" onclick="toggleDate('${ds}')">${label}<span class="num">${d}</span>${ini ? `<span class="ini">${ini}</span>` : ''}</div>`;
            }
            
            const totalCells = firstDay + daysInMonth;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remaining; i++) h += '<div class="dc empty"></div>';
            
            grid.innerHTML = h;
            document.getElementById('navMonth').textContent = MOIS[currentMonth];
            document.getElementById('navYear').textContent = currentYear;
        }

        function updN() { document.getElementById('selN').textContent = sel.size; }

        // ============ ACTIONS ============
        function selG(id) { G = id; renderG(); }
        function toggleDate(ds) { sel.has(ds) ? sel.delete(ds) : sel.add(ds); renderCal(); updN(); }
        function navP(dir) {
            currentMonth += dir;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCal();
        }

        let touchStartX = 0;
        function initSwipe() {
            const container = document.getElementById('swipeContainer');
            container.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            container.addEventListener('touchend', (e) => {
                const diff = touchStartX - e.changedTouches[0].screenX;
                if (Math.abs(diff) > 50) navP(diff > 0 ? 1 : -1);
            }, { passive: true });
        }

        async function effacer() {
            if (sel.size === 0) { toast('S√©lectionne des dates', 'info'); return; }
            let supprime = false;
            data.reservations.forEach(r => {
                if (r.dates) {
                    const avant = r.dates.length;
                    r.dates = r.dates.filter(d => !sel.has(d));
                    if (r.dates.length < avant) supprime = true;
                }
            });
            data.reservations = data.reservations.filter(r => r.dates && r.dates.length > 0);
            if (supprime) { const ok = await sauvegarder(); if (ok) toast('Supprim√© ‚úì', 'ok'); }
            else toast('Aucune r√©servation', 'info');
            sel.clear(); renderCal(); updN();
        }

        function reserver() {
            if (sel.size === 0) { toast('S√©lectionne des dates', 'info'); return; }
            const g = GRP.find(x => x.id === G);
            document.getElementById('groupBadge').className = 'group-badge ' + G;
            document.getElementById('groupBadge').textContent = g.nom;
            document.getElementById('customRow').className = 'fg custom-row' + (G === 'autres' ? ' show' : '');
            document.getElementById('datesBox').innerHTML = Array.from(sel).sort().map(ds => {
                const dt = new Date(ds);
                return `<span class="date-chip">${dt.getDate()}/${dt.getMonth()+1}</span>`;
            }).join('');
            document.getElementById('mRes').classList.add('on');
        }

        async function confirmerRes() {
            let cust = '';
            if (G === 'autres') {
                cust = document.getElementById('customName').value.trim();
                if (!cust) { toast('Entre un nom', 'err'); return; }
            }
            data.reservations.forEach(r => { if (r.dates) r.dates = r.dates.filter(d => !sel.has(d)); });
            data.reservations = data.reservations.filter(r => r.dates && r.dates.length > 0);
            data.reservations.push({ id: Date.now(), groupId: G, customName: cust, dates: Array.from(sel), createdAt: new Date().toISOString() });
            const ok = await sauvegarder();
            if (ok) toast('R√©serv√© ‚úì', 'ok');
            closeM('mRes');
            document.getElementById('customName').value = '';
            sel.clear(); renderCal(); updN();
        }

        function openShare() { document.getElementById('shareUrl').value = location.href; document.getElementById('mShare').classList.add('on'); }
        function copyUrl() { navigator.clipboard.writeText(location.href); toast('Lien copi√© ! üìã', 'ok'); }
        function openHelp() { document.getElementById('mHelp').classList.add('on'); }
        function closeM(id) { document.getElementById(id).classList.remove('on'); }
        function toast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        async function init() {
            await initCloud();
            initSwipe();
            renderG();
            renderCal();
            updN();
            document.getElementById('loader').classList.add('hide');
            setInterval(() => { if (planningId && isOnline) chargerCloud(); }, 15000);
        }
        
        init();
    </script>
</body>
</html>
