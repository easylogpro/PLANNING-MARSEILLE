<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Planning Familial</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a2332;
            --bg-card: #253044;
            --bg-calendar: #c8d6e8;
            --bg-cell: #3d5a80;
            --text-dark: #1a2332;
            --text-light: #ffffff;
            --text-muted: #8899aa;
            
            --sabrina: #ff1a6c;
            --yacine: #00b8e6;
            --melinda: #ff8c00;
            --parents: #00d45a;
            --autres: #a0826d;
            
            --ferie: #ffd700;
            --vac: #b388ff;
            --we: #6a7a8a;
            --accent: #2980d9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { height: 100%; overflow: hidden; touch-action: pan-y; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-light);
        }

        .app {
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
            overflow: hidden;
        }

        /* HEADER - TITRE CENTR√â PLEINE LARGEUR */
        .header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 16px;
        }

        .month-display {
            flex: 1;
            text-align: center;
        }
        .month-name {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: 6px;
        }
        .month-year {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 700;
        }

        .header-btns { display: flex; gap: 8px; }
        .icon-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.4rem;
            cursor: pointer;
        }
        .icon-btn:active { background: var(--accent); transform: scale(0.95); }

        /* GROUPES - PLEINE LARGEUR */
        .groups {
            display: flex;
            gap: 6px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 16px;
        }

        .grp {
            flex: 1;
            padding: 18px 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.3rem;
            font-weight: 800;
            text-align: center;
            border: 3px solid;
        }

        .grp:active { transform: scale(0.95); }

        .grp.sabrina { background: rgba(255,26,108,0.15); color: var(--sabrina); border-color: var(--sabrina); }
        .grp.yacine { background: rgba(0,184,230,0.15); color: var(--yacine); border-color: var(--yacine); }
        .grp.melinda { background: rgba(255,107,53,0.15); color: var(--melinda); border-color: var(--melinda); }
        .grp.parents { background: rgba(0,212,90,0.15); color: var(--parents); border-color: var(--parents); }
        .grp.autres { background: rgba(255,204,0,0.15); color: var(--autres); border-color: var(--autres); }

        .grp.on {
            animation: pulseGlow 1.2s ease-in-out infinite;
            transform: scale(1.05);
        }

        .grp.sabrina.on { background: var(--sabrina); color: white; box-shadow: 0 0 30px var(--sabrina); }
        .grp.yacine.on { background: var(--yacine); color: white; box-shadow: 0 0 30px var(--yacine); }
        .grp.melinda.on { background: var(--melinda); color: white; box-shadow: 0 0 30px var(--melinda); }
        .grp.parents.on { background: var(--parents); color: white; box-shadow: 0 0 30px var(--parents); }
        .grp.autres.on { background: var(--autres); color: white; box-shadow: 0 0 30px var(--autres); }

        @keyframes pulseGlow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* CALENDRIER - FOND CLAIR AUTOUR DES CASES */
        .cal-wrap {
            flex: 1;
            background: var(--bg-calendar);
            border-radius: 18px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        /* L√âGENDE */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 8px;
            font-size: 0.85rem;
            font-weight: 800;
            color: var(--text-dark);
        }

        .leg { display: flex; align-items: center; gap: 6px; }
        .leg-box { width: 16px; height: 16px; border-radius: 5px; }
        .leg-box.fer { background: var(--ferie); }
        .leg-box.vac { background: #5a7a9a; border: none; }
        .leg-box.we { background: var(--we); }

        .days-head {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }

        .dh {
            text-align: center;
            font-size: 0.95rem;
            font-weight: 900;
            color: var(--text-dark);
            padding: 6px 0;
        }

        /* CONTAINER SWIPE */
        .swipe-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            touch-action: pan-x;
        }

        .days {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 5px;
            transition: transform 0.3s ease;
        }

        /* CELLULE JOUR */
        .dc {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-cell);
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            border: 3px solid transparent;
            gap: 2px;
        }

        .dc:active { transform: scale(0.92); }
        .dc.empty { background: transparent; cursor: default; }
        .dc.empty:active { transform: none; }

        .dc .label {
            font-size: 0.55rem;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            line-height: 1;
        }

        .dc .num { 
            font-size: 1.4rem; 
            font-weight: 900; 
            line-height: 1;
            color: white;
        }

        .dc .ini { 
            font-size: 0.7rem; 
            font-weight: 900; 
            line-height: 1;
            color: white;
        }

        .dc.we { background: var(--we); }
        .dc.fer { background: var(--ferie); }
        .dc.fer .num, .dc.fer .label { color: #000; }
        .dc.vac { background: #5a7a9a; border: none; }

        .dc.sel {
            border-color: var(--accent) !important;
            box-shadow: 0 0 15px var(--accent);
        }

        .dc.res.sabrina { background: var(--sabrina) !important; }
        .dc.res.yacine { background: var(--yacine) !important; }
        .dc.res.melinda { background: var(--melinda) !important; }
        .dc.res.parents { background: var(--parents) !important; }
        .dc.res.autres { background: var(--autres) !important; }

        .swipe-hint {
            text-align: center;
            font-size: 0.7rem;
            color: var(--text-dark);
            padding: 4px;
            opacity: 0.7;
        }

        /* BARRE DU BAS */
        .bottom-bar {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 16px;
        }

        .bottom-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
        }
        .nav-btn:active { transform: scale(0.92); opacity: 0.8; }

        .status {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .sync-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--parents);
            animation: pulse 2s infinite;
        }
        .sync-dot.off { background: var(--ferie); animation: none; }

        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.4} }

        .sync-txt {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .sel-count {
            font-size: 1rem;
            font-weight: 800;
        }
        .sel-count b { color: var(--accent); font-size: 1.2rem; }

        .visu-link {
            padding: 12px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 800;
        }
        .visu-link:active { background: var(--accent); }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 18px 20px;
            border-radius: 14px;
            border: none;
            font-family: 'Nunito', sans-serif;
            font-size: 1.3rem;
            font-weight: 900;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.95); }
        .btn-danger { background: #ff3b4a; color: white; }
        .btn-primary { background: var(--accent); color: white; }

        /* ============ VISU 6 MOIS - √âLARGI ============ */
        .visu-page {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 500;
            background: var(--bg-primary);
            flex-direction: column;
            padding: 6px;
            gap: 6px;
        }
        .visu-page.on { display: flex; }

        .visu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: var(--bg-card);
            border-radius: 14px;
        }

        .visu-title { 
            font-size: 1.8rem; 
            font-weight: 900; 
        }

        .visu-close {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            border: none;
            background: var(--ferie);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .visu-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            padding: 6px;
        }

        .visu-leg {
            padding: 8px 16px;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 800;
            color: white;
        }
        .visu-leg.sabrina { background: var(--sabrina); }
        .visu-leg.yacine { background: var(--yacine); }
        .visu-leg.melinda { background: var(--melinda); }
        .visu-leg.parents { background: var(--parents); }
        .visu-leg.autres { background: var(--autres); }

        /* GRILLE 6 MOIS - 2 COLONNES PLEINE LARGEUR */
        .visu-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(3, 1fr);
            gap: 8px;
            overflow: hidden;
        }

        .visu-month {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .visu-month-head {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 900;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .visu-days-head {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .visu-dh {
            text-align: center;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-muted);
        }

        .visu-days {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            align-content: start;
        }

        .visu-dc {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 800;
        }

        .visu-dc.empty { background: transparent; }
        .visu-dc.we { background: rgba(255,255,255,0.05); color: var(--text-muted); }
        .visu-dc.fer { background: var(--ferie); color: #000; }
        .visu-dc.vac { background: rgba(255,255,255,0.25); }
        .visu-dc.res.sabrina { background: var(--sabrina); color: white; }
        .visu-dc.res.yacine { background: var(--yacine); color: white; }
        .visu-dc.res.melinda { background: var(--melinda); color: white; }
        .visu-dc.res.parents { background: var(--parents); color: white; }
        .visu-dc.res.autres { background: var(--autres); color: white; }

        .visu-nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: var(--bg-card);
            border-radius: 12px;
        }

        /* MODALS */
        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-bg.on { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 360px;
            animation: popIn 0.2s ease;
        }

        @keyframes popIn { from{transform:scale(0.9);opacity:0}to{transform:scale(1);opacity:1} }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .modal-title { font-size: 1.2rem; font-weight: 900; }
        .modal-x {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .group-badge {
            display: inline-block;
            padding: 10px 22px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 900;
            margin-bottom: 16px;
            color: white;
        }
        .group-badge.sabrina { background: var(--sabrina); }
        .group-badge.yacine { background: var(--yacine); }
        .group-badge.melinda { background: var(--melinda); }
        .group-badge.parents { background: var(--parents); }
        .group-badge.autres { background: var(--autres); }

        .fg { margin-bottom: 14px; }
        .fl { display: block; font-size: 0.9rem; font-weight: 800; margin-bottom: 8px; color: var(--text-muted); }
        .fi {
            width: 100%;
            padding: 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
        }
        .fi:focus { outline: none; border-color: var(--accent); }

        .dates-box {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 100px;
            overflow-y: auto;
        }

        .date-chip {
            padding: 6px 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 800;
        }

        .modal-btns { display: flex; gap: 12px; margin-top: 18px; }
        .modal-btns .btn { flex: 1; }

        .share-url {
            width: 100%;
            padding: 14px;
            background: rgba(0,0,0,0.3);
            border: none;
            border-radius: 12px;
            color: var(--accent);
            font-size: 0.8rem;
            font-family: monospace;
            margin: 14px 0;
            text-align: center;
        }

        .help-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 12px;
        }
        .help-text b { color: white; }

        .toasts { position: fixed; top: 70px; left: 12px; right: 12px; z-index: 2000; }
        .toast {
            padding: 14px 18px;
            background: var(--bg-card);
            border-radius: 14px;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 800;
            animation: slideDown 0.2s ease;
        }
        .toast.ok { border-left: 5px solid var(--parents); }
        .toast.err { border-left: 5px solid var(--ferie); }
        .toast.info { border-left: 5px solid var(--accent); }

        @keyframes slideDown { from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)} }

        .loading {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            z-index: 3000;
        }
        .loading.hide { display: none; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to{transform:rotate(360deg)} }

        .custom-row { display: none; }
        .custom-row.show { display: block; }
    </style>
</head>
<body>
    <div class="loading" id="loader">
        <div class="spinner"></div>
        <span style="color:var(--text-muted);font-size:1rem">Connexion...</span>
    </div>

    <!-- PAGE PRINCIPALE -->
    <div class="app">
        <!-- HEADER -->
        <div class="header">
            <div class="month-display">
                <div class="month-name" id="navMonth">Janvier</div>
                <div class="month-year" id="navYear">2026</div>
            </div>
            <div class="header-btns">
                <button class="icon-btn" onclick="openHelp()">‚ùì</button>
                <button class="icon-btn" onclick="openShare()">üîó</button>
            </div>
        </div>

        <!-- GROUPES - PLEINE LARGEUR -->
        <div class="groups" id="grps"></div>

        <!-- CALENDRIER -->
        <div class="cal-wrap">
            <div class="legend">
                <div class="leg"><div class="leg-box fer"></div><span>F√©ri√©</span></div>
                <div class="leg"><div class="leg-box vac"></div><span>Vacances</span></div>
                <div class="leg"><div class="leg-box we"></div><span>WE</span></div>
            </div>
            <div class="days-head">
                <span class="dh">Lun</span>
                <span class="dh">Mar</span>
                <span class="dh">Mer</span>
                <span class="dh">Jeu</span>
                <span class="dh">Ven</span>
                <span class="dh">Sam</span>
                <span class="dh">Dim</span>
            </div>
            <div class="swipe-container" id="swipeContainer">
                <div class="days" id="daysGrid"></div>
            </div>
            <div class="swipe-hint">‚Üê Balayer pour changer de mois ‚Üí</div>
        </div>

        <!-- BARRE DU BAS -->
        <div class="bottom-bar">
            <div class="bottom-row">
                <button class="nav-btn" onclick="navP(-1)">‚óÄ</button>
                <div class="status">
                    <div class="sync-dot" id="syncDot"></div>
                    <span class="sync-txt" id="syncTxt">Connexion...</span>
                </div>
                <div class="sel-count"><b id="selN">0</b> s√©lect.</div>
                <a href="#" class="visu-link" onclick="openVisu();return false;">üìÖ 6 mois</a>
                <button class="nav-btn" onclick="navP(1)">‚ñ∂</button>
            </div>
            <div class="action-btns">
                <button class="btn btn-danger" onclick="effacer()">Effacer</button>
                <button class="btn btn-primary" onclick="reserver()">R√©server</button>
            </div>
        </div>
    </div>

    <!-- PAGE VISU 6 MOIS -->
    <div class="visu-page" id="visuPage">
        <div class="visu-header">
            <div class="visu-title" id="visuTitle">Jan - Jun 2026</div>
            <button class="visu-close" onclick="closeVisu()">‚úï</button>
        </div>

        <div class="visu-legend">
            <div class="visu-leg sabrina">Sabrina</div>
            <div class="visu-leg yacine">Yacine</div>
            <div class="visu-leg melinda">Melinda</div>
            <div class="visu-leg parents">Parents</div>
            <div class="visu-leg autres">Autres</div>
        </div>

        <div class="visu-grid" id="visuGrid"></div>

        <div class="visu-nav-bar">
            <button class="nav-btn" onclick="visuNav(-6)">‚óÄ 6 mois</button>
            <button class="nav-btn" onclick="visuNav(6)">6 mois ‚ñ∂</button>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-bg" id="mRes" onclick="if(event.target===this)closeM('mRes')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">R√©servation</h2>
                <button class="modal-x" onclick="closeM('mRes')">√ó</button>
            </div>
            <div class="group-badge" id="groupBadge">Sabrina</div>
            <div class="fg custom-row" id="customRow">
                <label class="fl">Nom</label>
                <input type="text" class="fi" id="customName" placeholder="Pr√©nom...">
            </div>
            <div class="fg">
                <label class="fl">Dates s√©lectionn√©es</label>
                <div class="dates-box" id="datesBox"></div>
            </div>
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="confirmerRes()">Confirmer</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="mShare" onclick="if(event.target===this)closeM('mShare')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">üîó Partager</h2>
                <button class="modal-x" onclick="closeM('mShare')">√ó</button>
            </div>
            <p class="help-text"><b>Envoie ce lien √† la famille !</b><br>Tous verront le m√™me planning.</p>
            <input type="text" class="share-url" id="shareUrl" readonly onclick="this.select()">
            <div class="modal-btns">
                <button class="btn btn-primary" onclick="copyUrl()">üìã Copier le lien</button>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="mHelp" onclick="if(event.target===this)closeM('mHelp')">
        <div class="modal">
            <div class="modal-head">
                <h2 class="modal-title">‚ùì Aide</h2>
                <button class="modal-x" onclick="closeM('mHelp')">√ó</button>
            </div>
            <p class="help-text" style="background:rgba(0,212,90,0.2);padding:14px;border-radius:12px;margin-bottom:16px">
                <b style="color:var(--parents)">‚úì Sauvegarde 100% en ligne</b><br>
                JSONBlob.com = gratuit, <b>PAS DE COMPTE</b> !<br>
                Tout est automatique.
            </p>
            <p class="help-text"><b>R√©server :</b> Groupe ‚Üí Jours ‚Üí R√©server</p>
            <p class="help-text"><b>Supprimer :</b> Jours ‚Üí Effacer</p>
            <p class="help-text"><b>Changer mois :</b> Fl√®ches ou balayer</p>
        </div>
    </div>

    <div class="toasts" id="toasts"></div>

    <script>
        // ============ 100% EN LIGNE - JSONBlob via proxy CORS ============
        const PROXY = 'https://corsproxy.io/?';
        const API_RAW = 'https://jsonblob.com/api/jsonBlob';
        const API = PROXY + encodeURIComponent(API_RAW);
        
        const MOIS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
        const MOIS_COURT = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
        const GRP = [
            {id:'sabrina', nom:'Sabrina', ini:'SAB'},
            {id:'yacine', nom:'Yacine', ini:'YAC'},
            {id:'melinda', nom:'Melinda', ini:'MEL'},
            {id:'parents', nom:'Parents', ini:'PAR'},
            {id:'autres', nom:'Autres', ini:'AUT'}
        ];

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let visuMonth = 0;
        let visuYear = new Date().getFullYear();
        let G = 'sabrina';
        let sel = new Set();
        let data = { reservations: [] };
        let blobId = null;
        let isOnline = false;

        // ============ CLOUD ============
        async function initCloud() {
            const params = new URLSearchParams(location.search);
            blobId = params.get('id');
            
            if (blobId) {
                const ok = await chargerCloud();
                if (ok) {
                    updateUrl();
                    return;
                }
            }
            await creerCloud();
        }

        async function creerCloud() {
            setSync(false, 'Cr√©ation...');
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('Erreur ' + response.status);
                // R√©cup√©rer l'ID depuis le header x-]jsonblob ou g√©n√©rer depuis la r√©ponse
                const text = await response.text();
                // JSONBlob retourne l'ID dans le header Location ou dans la r√©ponse
                const loc = response.headers.get('x-]jsonblob') || response.headers.get('Location');
                if (loc) {
                    blobId = loc.split('/').pop();
                } else {
                    // Essayer de parser la r√©ponse pour trouver l'ID
                    try {
                        const json = JSON.parse(text);
                        if (json.id) blobId = json.id;
                    } catch(e) {}
                }
                
                if (blobId) {
                    updateUrl();
                    setSync(true);
                    toast('Planning cr√©√© !', 'ok');
                } else {
                    throw new Error('Pas d\'ID re√ßu');
                }
            } catch(e) {
                console.error(e);
                setSync(false, 'Erreur connexion');
                toast('Erreur connexion', 'err');
            }
        }

        async function sauvegarder() {
            if (!blobId) return false;
            setSync(false, 'Sauvegarde...');
            try {
                const url = PROXY + encodeURIComponent(`${API_RAW}/${blobId}`);
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response.ok) throw new Error('Erreur ' + response.status);
                setSync(true);
                return true;
            } catch(e) {
                console.error(e);
                setSync(false, 'Erreur');
                return false;
            }
        }

        async function chargerCloud() {
            if (!blobId) return false;
            setSync(false, 'Chargement...');
            try {
                const url = PROXY + encodeURIComponent(`${API_RAW}/${blobId}`);
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erreur ' + response.status);
                data = await response.json();
                if (!data.reservations) data.reservations = [];
                renderCal();
                renderVisu();
                setSync(true);
                return true;
            } catch(e) {
                console.error(e);
                setSync(false, 'Erreur');
                return false;
            }
        }

        function updateUrl() {
            if (blobId) {
                const url = `${location.origin}${location.pathname}?id=${blobId}`;
                history.replaceState({}, '', url);
                document.getElementById('shareUrl').value = url;
            }
        }

        function setSync(ok, txt) {
            isOnline = ok;
            document.getElementById('syncDot').className = 'sync-dot' + (ok ? '' : ' off');
            document.getElementById('syncTxt').textContent = txt || (ok ? 'En ligne ‚úì' : 'Hors ligne');
        }

        // ============ F√âRI√âS ============
        function feries(y) {
            const f = [`${y}-01-01`, `${y}-05-01`, `${y}-05-08`, `${y}-07-14`, `${y}-08-15`, `${y}-11-01`, `${y}-11-11`, `${y}-12-25`];
            const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4;
            const z=Math.floor((b+8)/25),g=Math.floor((b-z+1)/3);
            const h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4;
            const l=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*l)/451);
            const mo=Math.floor((h+l-7*m+114)/31),da=((h+l-7*m+114)%31)+1;
            const p=new Date(y,mo-1,da);
            const add=(dt,n)=>{const r=new Date(dt);r.setDate(dt.getDate()+n);return fmt(r)};
            f.push(add(p,1), add(p,39), add(p,50));
            return new Set(f);
        }

        // ============ VACANCES ============
        function vacances(y) {
            const v=[];
            const add=(s,e)=>{const sd=new Date(s),ed=new Date(e);for(let d=new Date(sd);d<=ed;d.setDate(d.getDate()+1))if(d.getFullYear()===y)v.push(fmt(d))};
            if(y===2025){add('2025-02-22','2025-03-10');add('2025-04-19','2025-05-05');add('2025-07-05','2025-09-01');add('2025-10-18','2025-11-03');add('2025-12-20','2025-12-31')}
            if(y===2026){add('2026-01-01','2026-01-05');add('2026-02-14','2026-03-02');add('2026-04-11','2026-04-27');add('2026-07-04','2026-09-01');add('2026-10-17','2026-11-02');add('2026-12-19','2026-12-31')}
            return new Set(v);
        }

        function fmt(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

        // ============ RENDER ============
        function renderG() {
            document.getElementById('grps').innerHTML = GRP.map(g => 
                `<div class="grp ${g.id} ${G===g.id?'on':''}" onclick="selG('${g.id}')">${g.nom}</div>`
            ).join('');
        }

        function renderCal() {
            const grid = document.getElementById('daysGrid');
            const ferSet = feries(currentYear);
            const vacSet = vacances(currentYear);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = (new Date(currentYear, currentMonth, 1).getDay() + 6) % 7;
            
            let h = '';
            for (let i = 0; i < firstDay; i++) h += '<div class="dc empty"></div>';
            
            for (let d = 1; d <= daysInMonth; d++) {
                const dt = new Date(currentYear, currentMonth, d);
                const ds = fmt(dt);
                const dow = (dt.getDay() + 6) % 7;
                const isWE = dow >= 5;
                const isFer = ferSet.has(ds);
                const isVac = vacSet.has(ds);
                const res = data.reservations.find(r => r.dates && r.dates.includes(ds));
                const isSel = sel.has(ds);
                
                let cls = ['dc'];
                let label = '';
                let ini = '';
                
                if (isFer) label = '<span class="label">F√âRI√â</span>';
                else if (isVac) label = '<span class="label">VAC</span>';
                
                if (res) {
                    cls.push('res', res.groupId);
                    const g = GRP.find(x => x.id === res.groupId);
                    ini = res.customName ? res.customName.substring(0,3).toUpperCase() : g.ini;
                } else if (isFer) {
                    cls.push('fer');
                } else if (isVac) {
                    cls.push('vac');
                } else if (isWE) {
                    cls.push('we');
                }
                
                if (isSel) cls.push('sel');
                
                h += `<div class="${cls.join(' ')}" onclick="toggleDate('${ds}')">${label}<span class="num">${d}</span>${ini ? `<span class="ini">${ini}</span>` : ''}</div>`;
            }
            
            const totalCells = firstDay + daysInMonth;
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remaining; i++) h += '<div class="dc empty"></div>';
            
            grid.innerHTML = h;
            document.getElementById('navMonth').textContent = MOIS[currentMonth];
            document.getElementById('navYear').textContent = currentYear;
        }

        function renderVisu() {
            const grid = document.getElementById('visuGrid');
            let h = '';
            
            for (let m = 0; m < 6; m++) {
                const month = (visuMonth + m) % 12;
                const year = visuYear + Math.floor((visuMonth + m) / 12);
                const ferSet = feries(year);
                const vacSet = vacances(year);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
                
                h += `<div class="visu-month"><div class="visu-month-head">${MOIS[month]} ${year}</div>
                    <div class="visu-days-head"><span class="visu-dh">L</span><span class="visu-dh">M</span><span class="visu-dh">M</span><span class="visu-dh">J</span><span class="visu-dh">V</span><span class="visu-dh">S</span><span class="visu-dh">D</span></div>
                    <div class="visu-days">`;
                
                for (let i = 0; i < firstDay; i++) h += '<div class="visu-dc empty"></div>';
                
                for (let d = 1; d <= daysInMonth; d++) {
                    const dt = new Date(year, month, d);
                    const ds = fmt(dt);
                    const dow = (dt.getDay() + 6) % 7;
                    const isFer = ferSet.has(ds);
                    const isVac = vacSet.has(ds);
                    const res = data.reservations.find(r => r.dates && r.dates.includes(ds));
                    
                    let cls = ['visu-dc'];
                    if (res) cls.push('res', res.groupId);
                    else if (isFer) cls.push('fer');
                    else if (isVac) cls.push('vac');
                    else if (dow >= 5) cls.push('we');
                    
                    h += `<div class="${cls.join(' ')}">${d}</div>`;
                }
                h += '</div></div>';
            }
            
            grid.innerHTML = h;
            const endMonthIdx = (visuMonth + 5) % 12;
            const endYear = visuYear + Math.floor((visuMonth + 5) / 12);
            document.getElementById('visuTitle').textContent = `${MOIS_COURT[visuMonth]} ${visuYear} - ${MOIS_COURT[endMonthIdx]} ${endYear}`;
        }

        function updN() { document.getElementById('selN').textContent = sel.size; }

        // ============ ACTIONS ============
        function selG(id) { G = id; renderG(); }
        function toggleDate(ds) { sel.has(ds) ? sel.delete(ds) : sel.add(ds); renderCal(); updN(); }
        function navP(dir) {
            currentMonth += dir;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCal();
        }

        // ============ SWIPE ============
        let touchStartX = 0;
        function initSwipe() {
            const container = document.getElementById('swipeContainer');
            container.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            container.addEventListener('touchend', (e) => {
                const diff = touchStartX - e.changedTouches[0].screenX;
                if (Math.abs(diff) > 50) navP(diff > 0 ? 1 : -1);
            }, { passive: true });
        }

        // ============ VISU ============
        function openVisu() { visuMonth = currentMonth; visuYear = currentYear; renderVisu(); document.getElementById('visuPage').classList.add('on'); }
        function closeVisu() { document.getElementById('visuPage').classList.remove('on'); }
        function visuNav(dir) {
            visuMonth += dir;
            while (visuMonth > 11) { visuMonth -= 12; visuYear++; }
            while (visuMonth < 0) { visuMonth += 12; visuYear--; }
            renderVisu();
        }

        // ============ EFFACER ============
        async function effacer() {
            if (sel.size === 0) { toast('S√©lectionne des dates', 'info'); return; }
            let supprime = false;
            data.reservations.forEach(r => {
                if (r.dates) {
                    const avant = r.dates.length;
                    r.dates = r.dates.filter(d => !sel.has(d));
                    if (r.dates.length < avant) supprime = true;
                }
            });
            data.reservations = data.reservations.filter(r => r.dates && r.dates.length > 0);
            if (supprime) { const ok = await sauvegarder(); if (ok) toast('Supprim√© ‚úì', 'ok'); }
            else toast('Aucune r√©servation', 'info');
            sel.clear(); renderCal(); renderVisu(); updN();
        }

        // ============ R√âSERVER ============
        function reserver() {
            if (sel.size === 0) { toast('S√©lectionne des dates', 'info'); return; }
            const g = GRP.find(x => x.id === G);
            document.getElementById('groupBadge').className = 'group-badge ' + G;
            document.getElementById('groupBadge').textContent = g.nom;
            document.getElementById('customRow').className = 'fg custom-row' + (G === 'autres' ? ' show' : '');
            document.getElementById('datesBox').innerHTML = Array.from(sel).sort().map(ds => {
                const dt = new Date(ds);
                return `<span class="date-chip">${dt.getDate()}/${dt.getMonth()+1}</span>`;
            }).join('');
            document.getElementById('mRes').classList.add('on');
        }

        async function confirmerRes() {
            let cust = '';
            if (G === 'autres') {
                cust = document.getElementById('customName').value.trim();
                if (!cust) { toast('Entre un nom', 'err'); return; }
            }
            data.reservations.forEach(r => { if (r.dates) r.dates = r.dates.filter(d => !sel.has(d)); });
            data.reservations = data.reservations.filter(r => r.dates && r.dates.length > 0);
            data.reservations.push({ id: Date.now(), groupId: G, customName: cust, dates: Array.from(sel), createdAt: new Date().toISOString() });
            const ok = await sauvegarder();
            if (ok) toast('R√©serv√© ‚úì', 'ok');
            closeM('mRes');
            document.getElementById('customName').value = '';
            sel.clear(); renderCal(); renderVisu(); updN();
        }

        // ============ MODALS ============
        function openShare() { document.getElementById('shareUrl').value = location.href; document.getElementById('mShare').classList.add('on'); }
        function copyUrl() { navigator.clipboard.writeText(location.href); toast('Lien copi√© ! üìã', 'ok'); }
        function openHelp() { document.getElementById('mHelp').classList.add('on'); }
        function closeM(id) { document.getElementById(id).classList.remove('on'); }
        function toast(msg, type='info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3500);
        }

        // ============ INIT ============
        async function init() {
            await initCloud();
            initSwipe();
            renderG();
            renderCal();
            renderVisu();
            updN();
            document.getElementById('loader').classList.add('hide');
            setInterval(() => { if (blobId && isOnline) chargerCloud(); }, 15000);
        }
        
        init();
    </script>
</body>
</html>
